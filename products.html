<input class="shade-check" type="checkbox" value="${s}">
          <span>${s}</span>
        </label>
        <div class="qty">
          <button type="button" class="qty-minus" disabled>−</button>
          <span class="count">1</span>
          <button type="button" class="qty-plus" disabled>+</button>
        </div>
      </div>
    `).join("");
    shadeModal.classList.add("open");
  }

  // закрытия
  function closeModal(){ shadeModal.classList.remove("open"); }
  modalClose.addEventListener("click", closeModal);
  btnBack.addEventListener("click", closeModal);
  shadeModal.addEventListener("click", (e)=>{ if(e.target===shadeModal) closeModal(); });

  // включаем/выключаем кнопки +/- при чекбоксе
  shadePicker.addEventListener("change", (e)=>{
    if(!e.target.classList.contains("shade-check")) return;
    const row = e.target.closest(".shade-row");
    row.querySelector(".qty-minus").disabled = !e.target.checked;
    row.querySelector(".qty-plus").disabled  = !e.target.checked;
  });

  // обработка +/-
  shadePicker.addEventListener("click", (e)=>{
    const row = e.target.closest(".shade-row"); if(!row) return;
    const countEl = row.querySelector(".count");
    let num = parseInt(countEl.textContent,10);
    if (e.target.classList.contains("qty-plus"))  num++;
    if (e.target.classList.contains("qty-minus")) num = Math.max(1, num-1);
    countEl.textContent = num;
  });

  // --- КНОПКА «ЗАКАЗАТЬ» — отправка в бота или alert
  btnOrder.addEventListener("click", ()=>{
    if (!currentProduct) return;

    const selected = Array.from(shadePicker.querySelectorAll(".shade-row"))
      .map(row=>{
        const cb = row.querySelector(".shade-check");
        if(!cb.checked) return null;
        const qty = parseInt(row.querySelector(".count").textContent,10) || 1;
        return { shade: cb.value, qty };
      })
      .filter(Boolean);

    if(!selected.length){
      alert("Выберите хотя бы один оттенок");
      return;
    }

    const payload = {
      action: "add_to_cart",
      brand: selectedBrand,
      category: selectedCategory,
      product: currentProduct.name,
      price: currentProduct.price,
      items: selected
    };

    if (window.Telegram && window.Telegram.WebApp){
      try{
        Telegram.WebApp.sendData(JSON.stringify(payload));
        Telegram.WebApp.HapticFeedback?.notificationOccurred?.("success");
      }catch(err){
        console.log("sendData error", err);
      }
    }else{
      // фолбэк для тестов в браузере
      alert("Добавлено в корзину:\n" + JSON.stringify(payload, null, 2));
      console.log("Payload → bot:", payload);
    }
    closeModal();
  });
</script>
</body>
</html>
