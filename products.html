
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–¢–æ–≤–∞—Ä—ã</title>
  <style>
    :root{ --pink:#ff4d88; --pink-2:#ff79a8; --card-r:14px; }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#ff80b2,#ff9ac9); color:#fff; text-align:center;
    }
    h1{ margin:20px 0 10px; font-size:26px; }

    .search-container{
      display:flex; align-items:center; gap:12px;
      padding:10px 16px; margin:0 12px 16px;
      background:#fff; color:#111; border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
    .back-btn{ background:none; border:0; color:var(--pink); font-size:16px; cursor:pointer; }
    .search-input{ flex:1; border:0; outline:none; font-size:16px; }

    #productGrid{
      display:grid; grid-template-columns:repeat(4,1fr); gap:16px;
      max-width:1200px; margin:0 auto; padding:10px;
    }
    .product-card{
      background:#fff; color:#111; border-radius:var(--card-r);
      box-shadow:0 4px 12px rgba(0,0,0,.12);
      overflow:hidden; display:flex; flex-direction:column; align-items:center;
      transition:transform .2s;
    }
    .product-card:hover{ transform:translateY(-2px); }
    .product-card img{ width:100%; aspect-ratio:3/4; object-fit:cover; }
    .product-price{ color:var(--pink); font-weight:700; margin:12px 0 6px; }
    .product-name{ margin:0 10px 12px; text-align:center; }

    .select-shades-btn{
      margin:0 0 14px; border:0; border-radius:999px;
      padding:10px 14px; background:#eef0f4; color:#333; cursor:pointer;
    }
    .order-btn{
      margin:0 0 14px; border:0; border-radius:999px;
      padding:10px 14px; background:var(--pink); color:#fff; cursor:pointer;
    }

    /* ---------- Modal (iOS-style) ---------- */
    .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:1000; background:rgba(0,0,0,.45); }
    .modal.open{ display:grid; animation:fade .18s ease; }
    @keyframes fade{ from{opacity:0} to{opacity:1} }

    .modal-content{
      width:min(420px,92vw);
      background:#fff; color:#111; border-radius:20px; overflow:hidden;
      box-shadow:0 14px 32px rgba(0,0,0,.25);
      transform:translateY(12px); opacity:0; animation:pop .22s ease forwards;
    }
    @keyframes pop{ to{transform:none; opacity:1} }

    .modal-header{
      position:relative; display:flex; align-items:center; justify-content:center;
      gap:8px; padding:14px 18px; border-bottom:1px solid #eee; font-weight:700;
    }
    .modal-close{
      position:absolute; right:10px; top:8px; width:32px; height:32px;
      border-radius:50%; border:0; background:#f2f3f7; cursor:pointer; font-size:18px;
      display:grid; place-items:center;
    }

    .picker{ max-height:300px; overflow:auto; padding:6px 10px; }
    /* iOS-like scrollbar */
    .picker::-webkit-scrollbar{ width:8px; }
    .picker::-webkit-scrollbar-track{ background:transparent; }
    .picker::-webkit-scrollbar-thumb{ background:linear-gradient(180deg,var(--pink),var(--pink-2)); border-radius:10px; }
    .picker{ scrollbar-width:thin; scrollbar-color:var(--pink) transparent; }

    .shade-row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 6px; border-bottom:1px solid #f0f0f0;
    }
    .shade-row label{ display:flex; align-items:center; gap:8px; font-size:15px; }
    .shade-row input[type="checkbox"]{ accent-color:var(--pink); }

    .qty{ display:flex; align-items:center; gap:8px; background:#f6f7fb; border-radius:999px; padding:4px 8px; }
    .qty button{
      width:28px; height:28px; border-radius:50%; border:0; background:var(--pink); color:#fff;
      cursor:pointer; font-size:18px; line-height:1;
    }
    .qty .count{ min-width:20px; text-align:center; font-weight:600; }

    .modal-footer{ display:flex; gap:10px; justify-content:center; padding:14px; border-top:1px solid #eee; }
    .btn{ border:0; padding:10px 18px; border-radius:12px; cursor:pointer; font-weight:700; }
    .btn-light{ background:#f2f3f7; color:#333; }
    .btn-primary{ background:var(--pink); color:#fff; }

    /* –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ */
    .qty-wrapper { display:flex; align-items:center; gap:10px; }
    .qty-btn { background:var(--pink); color:#fff; border:0; width:34px; height:34px; border-radius:50%; font-size:18px; cursor:pointer; }
    .qty-count { min-width:26px; text-align:center; font-weight:700; }

    @media (max-width:1024px){ #productGrid{ grid-template-columns:repeat(3,1fr);} }
    @media (max-width:768px){  #productGrid{ grid-template-columns:repeat(2,1fr);} }
    @media (max-width:480px){  #productGrid{ grid-template-columns:repeat(2,1fr);} }
  </style>
</head>
<body>
  <h1>–¢–æ–≤–∞—Ä—ã</h1>

  <div class="search-container">
    <button class="back-btn" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>
    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." />
  </div>

  <div id="productGrid">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <!-- –ú–æ–¥–∞–ª –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è –ù–ï "–ö—Ä–∞—Å–∫–∞" -->
  <div id="qtyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>üß¥</span><span>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
        <button type="button" class="modal-close" id="qtyClose">√ó</button>
      </div>
      <div style="display:flex;justify-content:center;padding:14px;">
        <div class="qty-wrapper">
          <button type="button" class="qty-btn" id="qtyMinus">‚àí</button>
          <span class="qty-count" id="qtyCount">1</span>
          <button type="button" class="qty-btn" id="qtyPlus">+</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" id="qtyCancel">–ù–∞–∑–∞–¥</button>
        <button type="button" class="btn btn-primary" id="qtyAdd">–ó–∞–∫–∞–∑–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç—Ç–µ–Ω–∫–æ–≤ -->
  <div id="shadeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="shadeTitle">
    <div class="modal-content">
      <div class="modal-header">
        <span aria-hidden="true">üé®</span>
        <span id="shadeTitle">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—Ç–µ–Ω–æ–∫</span>
        <button type="button" id="modalClose" class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>
      <div id="shadePicker" class="picker"></div>
      <div class="modal-footer">
        <button type="button" id="btnBack" class="btn btn-light">–ù–∞–∑–∞–¥</button>
        <button type="button" id="btnOrder" class="btn btn-primary">–ó–∞–∫–∞–∑–∞—Ç—å</button>
      </div>
    </div>
  </div>

<script>
  // --- URL params + elements
  const params = new URLSearchParams(window.location.search);
  const selectedBrand    = params.get("brand");
  const selectedCategory = params.get("category");

  const productGrid = document.getElementById("productGrid");
  const searchInput = document.getElementById("searchInput");

  // shade modal
  const shadeModal  = document.getElementById("shadeModal");
  const shadePicker = document.getElementById("shadePicker");
  const modalClose  = document.getElementById("modalClose");
  const btnBack     = document.getElementById("btnBack");
  const btnOrder    = document.getElementById("btnOrder");

  // qty modal
  const qtyModal   = document.getElementById('qtyModal');
  const qtyMinus   = document.getElementById('qtyMinus');
  const qtyPlus    = document.getElementById('qtyPlus');
  const qtyCountEl = document.getElementById('qtyCount');
  const qtyCancel  = document.getElementById('qtyCancel');
  const qtyAdd     = document.getElementById('qtyAdd');
    fetch(jsonFile)
      .then(res => res.json())
      .then(data => {
        allProducts = data.filter(p => (p.category||"").trim().toLowerCase() === selectedCategory.trim().toLowerCase());
        if (!allProducts.length) productGrid.innerHTML = "<p style='color:white;'>‚ùå–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p>";
        else renderProducts(allProducts);
      })
      .catch(() => { productGrid.innerHTML = "<p style='color:white;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</p>"; });

  // --- render cards
  function renderProducts(list){
    productGrid.innerHTML = "";
    list.forEach(p => {
      const isColor   = (p.category || "").trim().toLowerCase() === "–∫—Ä–∞—Å–∫–∞";
      const hasShades = isColor && Array.isArray(p.shades) && p.shades.length > 0;

      const card = document.createElement("div");
      card.classList.add("product-card");

      const encodedShades = hasShades ? encodeURIComponent(JSON.stringify(p.shades)) : "";

      card.innerHTML = `
        <img src="${p.image}" alt="${p.name}">
        <div class="product-price">${p.price} ‚ÇΩ</div>
        <div class="product-name">${p.name}</div>
        ${
          hasShades
            ? `<button type="button" class="select-shades-btn"
                       data-name="${p.name}"
                       data-shades="${encodedShades}">–í—ã–±—Ä–∞—Ç—å –æ—Ç—Ç–µ–Ω–∫–∏</button>`
            : `<button type="button" class="order-btn"
                       data-name="${p.name}"
                       data-price="${p.price}">–ó–∞–∫–∞–∑–∞—Ç—å</button>`
        }
      `;
      productGrid.appendChild(card);

      // –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞ –æ—Ç—Ç–µ–Ω–∫–æ–≤
      if (hasShades) {
        card.querySelector(".select-shades-btn")
            .addEventListener("click", () => openModalFor(p));
      }
      // –∫–Ω–æ–ø–∫–∞ "–ó–∞–∫–∞–∑–∞—Ç—å" –¥–ª—è –ù–ï ¬´–ö—Ä–∞—Å–∫–∞¬ª –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–∏–∂–µ
    });
  }

  // --- search
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    renderProducts(allProducts.filter(p => p.name.toLowerCase().includes(q)));
  });

  // --- open shade modal
  function openModalFor(product){
    currentProduct = product;
    shadePicker.innerHTML = product.shades.map((s, i)=>`
      <div class="shade-row" data-index="${i}">
        <label>
          <input class="shade-check" type="checkbox" value="${s}">
          <span>${s}</span>
        </label>
        <div class="qty">
          <button type="button" class="qty-minus" disabled>‚àí</button>
          <span class="count">1</span>
          <button type="button" class="qty-plus" disabled>+</button>
        </div>
      </div>
    `).join("");
    shadeModal.classList.add("open");
  }

  // --- close shade modal
  function closeModal(){ shadeModal.classList.remove("open"); }
  modalClose.addEventListener("click", closeModal);
  btnBack.addEventListener("click", closeModal);
  shadeModal.addEventListener("click", (e)=>{ if(e.target===shadeModal) closeModal(); });

  // –≤–∫–ª—é—á–∞–µ–º/–≤—ã–∫–ª—é—á–∞–µ–º +/‚àí –ø—Ä–∏ —á–µ–∫–±–æ–∫—Å–µ
  shadePicker.addEventListener("change", (e)=>{
    if(!e.target.classList.contains("shade-check")) return;
    const row = e.target.closest(".shade-row");
    row.querySelector(".qty-minus").disabled = !e.target.checked;
    row.querySelector(".qty-plus").disabled  = !e.target.checked;
  });
  // –æ–±—Ä–∞–±–æ—Ç–∫–∞ +/‚àí
  shadePicker.addEventListener("click", (e)=>{
    const row = e.target.closest(".shade-row"); if(!row) return;
    const countEl = row.querySelector(".count");
    let num = parseInt(countEl.textContent,10);
    if (e.target.classList.contains("qty-plus"))  num++;
    if (e.target.classList.contains("qty-minus")) num = Math.max(1, num-1);
    countEl.textContent = num;
  });

  // --- ORDER from shade modal
  btnOrder.addEventListener("click", ()=>{
    if (!currentProduct) return;

    const selected = Array.from(shadePicker.querySelectorAll(".shade-row"))
      .map(row=>{
        const cb = row.querySelector(".shade-check");
        if(!cb.checked) return null;
        const qty = parseInt(row.querySelector(".count").textContent,10) || 1;
        return { shade: cb.value, qty };
      })
      .filter(Boolean);
  });
      const qtyClose   = document.getElementById('qtyClose');

  let allProducts = [];
  let currentProduct = null;          // —Ç–æ–≤–∞—Ä —Å –æ—Ç—Ç–µ–Ω–∫–∞–º–∏
  let currentSimpleProduct = null;    // –ø—Ä–æ—Å—Ç–æ–π —Ç–æ–≤–∞—Ä {name, price}
  let currentQty = 1;

  // --- load data
  if (!selectedBrand || !selectedCategory) {
    productGrid.innerHTML = "<p style='color:white;'>‚ùå–ë—Ä–µ–Ω–¥ –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω—ã!</p>";
  } else {
    const jsonFile = `data/${selectedBrand.toLowerCase()}.filter(Boolean);`

    if(!selected.length){ alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ—Ç—Ç–µ–Ω–æ–∫"); return; }

    const payload = {
      action: "add_to_cart",
      brand: selectedBrand,
      category: selectedCategory,
      product: currentProduct.name,
      price: currentProduct.price,
      items: selected
    };

    if (window.Telegram && window.Telegram.WebApp){
      try{
        Telegram.WebApp.sendData(JSON.stringify(payload));
        Telegram.WebApp.HapticFeedback?.notificationOccurred?.("success");
      }catch(err){ console.log("sendData error", err); }
    }else{
      alert("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É:\n" + JSON.stringify(payload, null, 2));
      console.log("Payload ‚Üí bot:", payload);
    }
    closeModal();
  });

  // ======= Qty modal for simple products =======
  function openQtyModal(product) {
    currentSimpleProduct = product;
    currentQty = 1;
    qtyCountEl.textContent = '1';
    qtyModal.classList.add('open');
  }
  function closeQtyModal() { qtyModal.classList.remove('open'); }
  qtyMinus.addEventListener('click', () => { currentQty = Math.max(1, currentQty - 1); qtyCountEl.textContent = String(currentQty); });
  qtyPlus .addEventListener('click', () => { currentQty += 1;            qtyCountEl.textContent = String(currentQty); });
  qtyCancel.addEventListener('click', closeQtyModal);
  qtyClose .addEventListener('click', closeQtyModal);
  qtyModal.addEventListener('click', (e)=>{ if(e.target===qtyModal) closeQtyModal(); });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ (–∑–∞–≥–ª—É—à–∫–∞ ‚Äî –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω/—á–∞—Ç –∏–ª–∏ WebApp)
  qtyAdd.addEventListener('click', async () => {
    const payload = {
      type: 'simple',
      brand: selectedBrand,
      category: selectedCategory,
      name: currentSimpleProduct?.name,
      price: currentSimpleProduct?.price,
      qty: currentQty
    };
    if (window.Telegram && window.Telegram.WebApp){
      try{ Telegram.WebApp.sendData(JSON.stringify(payload)); }
      catch(e){ console.log(e); }
    } else {
      alert("–í –∫–æ—Ä–∑–∏–Ω—É:\n" + JSON.stringify(payload, null, 2));
      console.log('–í –∫–æ—Ä–∑–∏–Ω—É (–ø—Ä–æ—Å—Ç–∞—è –ø–æ–∑–∏—Ü–∏—è):', payload);
    }
    closeQtyModal();
  });

  // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ "–ó–∞–∫–∞–∑–∞—Ç—å" –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ (–ù–ï "–ö—Ä–∞—Å–∫–∞")
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.order-btn');
    if (!btn) return;
    openQtyModal({
      name:  btn.getAttribute('data-name'),
      price: btn.getAttribute('data-price')
    });
  });
</script>
</body>
</html>
    
  
