<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Товары</title>
  <style>
    :root{
      --pink:#ff4d88;
      --pink-2:#ff79a8;
      --card-r:14px;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#ff80b2,#ff9ac9);
      color:#fff;
      text-align:center;
    }
    h1{ margin:20px 0 10px; font-size:26px; }

    .search-container{
      display:flex; align-items:center; gap:12px;
      padding:10px 16px; margin:0 12px 16px;
      background:#fff; color:#111; border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
    .back-btn{ background:none; border:0; color:var(--pink); font-size:16px; cursor:pointer; }
    .search-input{ flex:1; border:0; outline:none; font-size:16px; }

    #productGrid{
      display:grid; grid-template-columns:repeat(4,1fr); gap:16px;
      max-width:1200px; margin:0 auto; padding:10px;
    }
    .product-card{
      background:#fff; color:#111; border-radius:var(--card-r);
      box-shadow:0 4px 12px rgba(0,0,0,.12);
      overflow:hidden; display:flex; flex-direction:column; align-items:center;
      transition:transform .2s;
    }
    .product-card:hover{ transform:translateY(-2px); }
    .product-card img{ width:100%; aspect-ratio:3/4; object-fit:cover; }
    .product-price{ color:var(--pink); font-weight:700; margin:12px 0 6px; }
    .product-name{ margin:0 10px 12px; text-align:center; }

    .select-shades-btn{
      margin:0 0 14px;
      border:0; border-radius:999px;
      padding:10px 14px; background:#eef0f4; color:#333; cursor:pointer;
    }

    /* ---------- Modal (iOS-style) ---------- */
    .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:1000; background:rgba(0,0,0,.45); }
    .modal.open{ display:grid; animation:fade .18s ease; }
    @keyframes fade{ from{opacity:0} to{opacity:1} }

    .modal-content{
      width:min(420px,92vw);
      background:#fff; color:#111; border-radius:20px; overflow:hidden;
      box-shadow:0 14px 32px rgba(0,0,0,.25);
      transform:translateY(12px); opacity:0; animation:pop .22s ease forwards;
    }
    @keyframes pop{ to{transform:none; opacity:1} }

    .modal-header{
      position:relative; display:flex; align-items:center; justify-content:center;
      gap:8px; padding:14px 18px; border-bottom:1px solid #eee; font-weight:700;
    }
    .modal-close{
      position:absolute; right:10px; top:8px; width:32px; height:32px;
      border-radius:50%; border:0; background:#f2f3f7; cursor:pointer; font-size:18px;
      display:grid; place-items:center;
    }

    .picker{ max-height:300px; overflow:auto; padding:6px 10px; }
    /* iOS-like scrollbar */
    .picker::-webkit-scrollbar{ width:8px; }
    .picker::-webkit-scrollbar-track{ background:transparent; }
    .picker::-webkit-scrollbar-thumb{ background:linear-gradient(180deg,var(--pink),var(--pink-2)); border-radius:10px; }
    .picker{ scrollbar-width:thin; scrollbar-color:var(--pink) transparent; }

    .shade-row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 6px; border-bottom:1px solid #f0f0f0;
    }
    .shade-row label{ display:flex; align-items:center; gap:8px; font-size:15px; }
    .shade-row input[type="checkbox"]{ accent-color:var(--pink); }

    .qty{ display:flex; align-items:center; gap:8px; background:#f6f7fb; border-radius:999px; padding:4px 8px; }
    .qty button{
      width:28px; height:28px; border-radius:50%; border:0; background:var(--pink); color:#fff;
      cursor:pointer; font-size:18px; line-height:1;
    }
    .qty .count{ min-width:20px; text-align:center; font-weight:600; }

    .modal-footer{ display:flex; gap:10px; justify-content:center; padding:14px; border-top:1px solid #eee; }
    .btn{ border:0; padding:10px 18px; border-radius:12px; cursor:pointer; font-weight:700; }
    .btn-light{ background:#f2f3f7; color:#333; }
    .<input class="shade-check" type="checkbox" value="${s}">
          <span>${s}</span>
        </label>
        <div class="qty">
          <button type="button" class="qty-minus" disabled>−</button>
          <span class="count">1</span>
          <button type="button" class="qty-plus" disabled>+</button>
        </div>
      </div>
    `).join("");
    shadeModal.classList.add("open");
  }

  // закрытия
  function closeModal(){ shadeModal.classList.remove("open"); }
  modalClose.addEventListener("click", closeModal);
  btnBack.addEventListener("click", closeModal);
  shadeModal.addEventListener("click", (e)=>{ if(e.target===shadeModal) closeModal(); });

  // включаем/выключаем кнопки +/- при чекбоксе
  shadePicker.addEventListener("change", (e)=>{
    if(!e.target.classList.contains("shade-check")) return;
    const row = e.target.closest(".shade-row");
    row.querySelector(".qty-minus").disabled = !e.target.checked;
    row.querySelector(".qty-plus").disabled  = !e.target.checked;
  });

  // обработка +/-
  shadePicker.addEventListener("click", (e)=>{
    const row = e.target.closest(".shade-row"); if(!row) return;
    const countEl = row.querySelector(".count");
    let num = parseInt(countEl.textContent,10);
    if (e.target.classList.contains("qty-plus"))  num++;
    if (e.target.classList.contains("qty-minus")) num = Math.max(1, num-1);
    countEl.textContent = num;
  });

  // --- КНОПКА «ЗАКАЗАТЬ» — отправка в бота или alert
  btnOrder.addEventListener("click", ()=>{
    if (!currentProduct) return;

    const selected = Array.from(shadePicker.querySelectorAll(".shade-row"))
      .map(row=>{
        const cb = row.querySelector(".shade-check");
        if(!cb.checked) return null;
        const qty = parseInt(row.querySelector(".count").textContent,10) || 1;
        return { shade: cb.value, qty };
      })
      .filter(Boolean);

    if(!selected.length){
      alert("Выберите хотя бы один оттенок");
      return;
    }

    const payload = {
      action: "add_to_cart",
      brand: selectedBrand,
      category: selectedCategory,
      product: currentProduct.name,
      price: currentProduct.price,
      items: selected
    };

    if (window.Telegram && window.Telegram.WebApp){
      try{
        Telegram.WebApp.sendData(JSON.stringify(payload));
        Telegram.WebApp.HapticFeedback?.notificationOccurred?.("success");
      }catch(err){
        console.log("sendData error", err);
      }
    }else{
      // фолбэк для тестов в браузере
      alert("Добавлено в корзину:\n" + JSON.stringify(payload, null, 2));
      console.log("Payload → bot:", payload);
    }
    closeModal();
  });
</script>
</body>
</html>
